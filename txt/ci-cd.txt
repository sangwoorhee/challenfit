#!/bin/bash
set -euo pipefail

echo "ğŸš€ Challenfit Backend ë¸”ë£¨-ê·¸ë¦° ë°°í¬ ì‹œì‘ (Nginx ì—°ë™)..."

# í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
cd /home/ec2-user/challenfit_backend || { echo "âŒ ë””ë ‰í† ë¦¬ ì´ë™ ì‹¤íŒ¨"; exit 1; }

# .env íŒŒì¼ ì¡´ì¬ í™•ì¸ ë° Dockerìš© í™˜ê²½ë³€ìˆ˜ ì„¤ì •
if [ ! -f ".env" ]; then
    echo "âŒ .env íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ë°°í¬ë¥¼ ì¤‘ë‹¨í•©ë‹ˆë‹¤."
    exit 1
fi

# Dockerìš© .env íŒŒì¼ ìƒì„±
if [ ! -f ".env.docker" ]; then
    cp .env .env.docker
    sed -i 's/DB_HOST=localhost/DB_HOST=172.17.0.1/g' .env.docker
    sed -i 's/REDIS_HOST=localhost/REDIS_HOST=172.17.0.1/g' .env.docker
fi

# ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
echo "ğŸ” ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸..."
docker-compose -p challenfit-backend ps

# PM2 í”„ë¡œì„¸ìŠ¤ ì¤‘ì§€
if command -v pm2 &> /dev/null; then
    echo "ğŸ›‘ ê¸°ì¡´ PM2 í”„ë¡œì„¸ìŠ¤ ì¤‘ì§€..."
    pm2 stop challenfit-backend 2>/dev/null || true
    pm2 delete challenfit-backend 2>/dev/null || true
fi

# ë””ìŠ¤í¬ ì •ë¦¬
echo "ğŸ§¹ ë””ìŠ¤í¬ ì •ë¦¬ ì‹œì‘..."

# í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ ID ì €ì¥ (ë³´í˜¸ ëŒ€ìƒ)
RUNNING_CONTAINERS=$(docker ps -q)
echo "ğŸ”’ ë³´í˜¸í•  ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ: $(echo $RUNNING_CONTAINERS | wc -w)ê°œ"

# ë””ìŠ¤í¬ ì‚¬ìš©ë¥  ì²´í¬
DISK_USAGE=$(df /var/lib/docker | awk 'NR==2 {print int($5)}')
echo "ğŸ’¾ í˜„ì¬ Docker ë””ìŠ¤í¬ ì‚¬ìš©ë¥ : ${DISK_USAGE}%"

# ì‚¬ìš©ë¥ ì— ë”°ë¥¸ ì •ë¦¬ ê°•ë„ ì¡°ì ˆ
if [ "$DISK_USAGE" -gt 90 ]; then
    echo "ğŸš¨ ìœ„í—˜! ë””ìŠ¤í¬ ì‚¬ìš©ë¥  90% ì´ˆê³¼ - ìµœëŒ€ ê°•ë„ ì •ë¦¬"
    FILTER_TIME="1h"  # 1ì‹œê°„ ì´ìƒ ëœ ê²ƒ ëª¨ë‘ ì‚­ì œ
elif [ "$DISK_USAGE" -gt 70 ]; then
    echo "âš ï¸ ê²½ê³ ! ë””ìŠ¤í¬ ì‚¬ìš©ë¥  70% ì´ˆê³¼ - ê°•ë ¥ ì •ë¦¬"
    FILTER_TIME="24h"  # 24ì‹œê°„ ì´ìƒ ëœ ê²ƒ ì‚­ì œ
else
    echo "âœ… ë””ìŠ¤í¬ ì‚¬ìš©ë¥  ì–‘í˜¸ - ì¼ë°˜ ì •ë¦¬"
    FILTER_TIME="168h"  # 7ì¼ ì´ìƒ ëœ ê²ƒë§Œ ì‚­ì œ
fi

# 1ë‹¨ê³„: ì¢…ë£Œëœ ì»¨í…Œì´ë„ˆ ì‚­ì œ
echo "ğŸ“¦ ì¢…ë£Œëœ ì»¨í…Œì´ë„ˆ ì •ë¦¬..."
docker container prune -f

# 2ë‹¨ê³„: ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ë„¤íŠ¸ì›Œí¬ ì •ë¦¬
echo "ğŸŒ ë¯¸ì‚¬ìš© ë„¤íŠ¸ì›Œí¬ ì •ë¦¬..."
docker network prune -f

# 3ë‹¨ê³„: ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ë³¼ë¥¨ ì •ë¦¬ (ì£¼ì˜: ë°ì´í„° ì†ì‹¤ ê°€ëŠ¥)
echo "ğŸ’¿ ë¯¸ì‚¬ìš© ë³¼ë¥¨ ì •ë¦¬..."
docker volume prune -f

# 4ë‹¨ê³„: ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ ì •ë¦¬ (ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ ì œì™¸)
echo "ğŸ–¼ï¸  ë¯¸ì‚¬ìš© ì´ë¯¸ì§€ ì •ë¦¬ (${FILTER_TIME} ì´ìƒ)..."
# ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆì˜ ì´ë¯¸ì§€ëŠ” ë³´í˜¸ë¨
docker image prune -a -f --filter "until=${FILTER_TIME}"

# 5ë‹¨ê³„: ë¹Œë“œ ìºì‹œ ì™„ì „ ì •ë¦¬ (ê°€ì¥ ë§ì€ ê³µê°„ í™•ë³´)
echo "ğŸ”¨ ë¹Œë“œ ìºì‹œ ì™„ì „ ì •ë¦¬..."
docker builder prune -a -f --filter "until=${FILTER_TIME}"

# 6ë‹¨ê³„: ë””ìŠ¤í¬ ì‚¬ìš©ë¥ ì´ ì—¬ì „íˆ ë†’ìœ¼ë©´ ì¶”ê°€ ì •ë¦¬
DISK_USAGE_AFTER=$(df /var/lib/docker | awk 'NR==2 {print int($5)}')
if [ "$DISK_USAGE_AFTER" -gt 85 ]; then
    echo "ğŸ”¥ ì¶”ê°€ ê°•ë ¥ ì •ë¦¬ ì‹¤í–‰ (ì—¬ì „íˆ ${DISK_USAGE_AFTER}% ì‚¬ìš© ì¤‘)..."

    # ë” ì§§ì€ ì‹œê°„ í•„í„°ë¡œ ì¬ì •ë¦¬
    docker image prune -a -f --filter "until=1h"
    docker builder prune -a -f

    # ë¡œê·¸ íŒŒì¼ ì •ë¦¬ (í° íš¨ê³¼)
    echo "ğŸ“ Docker ë¡œê·¸ íŒŒì¼ ì •ë¦¬..."
    sudo truncate -s 0 /var/lib/docker/containers/*/*-json.log 2>/dev/null || true
fi

# 7ë‹¨ê³„: ìµœì¢… ì‹œìŠ¤í…œ ì •ë¦¬ (ì¤‘ë³µ ì œê±°)
echo "ğŸ¯ ìµœì¢… ì‹œìŠ¤í…œ ì •ë¦¬..."
docker system prune -f

# ì •ë¦¬ ê²°ê³¼ í™•ì¸
echo ""
echo "ğŸ“Š ì •ë¦¬ ì™„ë£Œ! ë””ìŠ¤í¬ ìƒíƒœ:"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
df -h /var/lib/docker | grep -v Filesystem
echo ""
docker system df
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# í™•ë³´ëœ ê³µê°„ ê³„ì‚°
if [ -n "$DISK_USAGE" ] && [ -n "$DISK_USAGE_AFTER" ]; then
    FREED=$((DISK_USAGE - DISK_USAGE_AFTER))
    echo "âœ¨ í™•ë³´ëœ ê³µê°„: ${FREED}%"
fi

# ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ í™•ì¸
echo ""
echo "âœ… ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ (ì˜í–¥ë°›ì§€ ì•ŠìŒ):"
docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

### 1. ì´ì „ ì¢…ë£Œëœ OLD ì»¨í…Œì´ë„ˆ ì‚­ì œ
for OLD_COLOR in backend-blue backend-green; do
  CONTAINER_NAME="challenfit-backend-${OLD_COLOR}-1"
  if docker inspect "$CONTAINER_NAME" >/dev/null 2>&1; then
    STATUS=$(docker inspect --format='{{.State.Status}}' "$CONTAINER_NAME")
    if [ "$STATUS" = "exited" ]; then
      echo "ğŸ—‘   ì´ì „ ì¢…ë£Œëœ ì»¨í…Œì´ë„ˆ ì‚­ì œ: $CONTAINER_NAME"
      docker-compose -p challenfit-backend rm -f "$OLD_COLOR" || true
    fi
  fi
done

### 2. Blue-Green ë°°í¬ ëŒ€ìƒ íŒë‹¨
ACTIVE_PORT=$(grep -E "server localhost:(3000|3002) max_fails" /etc/nginx/conf.d/challenfit.conf | grep -v "backup" | grep -oE "3000|3002" | head -1)

if [ "$ACTIVE_PORT" = "3000" ]; then
    OLD=backend-blue
    NEW=backend-green
    OLD_PORT=3000
    NEW_PORT=3002
else
    OLD=backend-green
    NEW=backend-blue
    OLD_PORT=3002
    NEW_PORT=3000
fi

echo "ğŸ”„ $OLD â†’ $NEW ìœ¼ë¡œ ì „í™˜í•©ë‹ˆë‹¤ (í¬íŠ¸: $OLD_PORT â†’ $NEW_PORT)"

### 3. ì†ŒìŠ¤ì½”ë“œ ê°±ì‹  ë° ë¹Œë“œ
echo "ğŸ“¥ ì†ŒìŠ¤ì½”ë“œ ì—…ë°ì´íŠ¸ ì¤‘..."
git fetch --all || { echo "âŒ git fetch ì‹¤íŒ¨"; exit 1; }
git reset --hard origin/main || { echo "âŒ git reset ì‹¤íŒ¨"; exit 1; }

# .env íŒŒì¼ ë°±ì—… ë° ë³µì›
cp .env .env.backup
if [ ! -f ".env" ] && [ -f ".env.backup" ]; then
    cp .env.backup .env
    echo "âœ… .env íŒŒì¼ ë³µì›ë¨"
fi

# í˜¸ìŠ¤íŠ¸ì˜ PostgreSQLê³¼ Redis 6 ì—°ê²° í…ŒìŠ¤íŠ¸
echo "â³ ë°ì´í„°ë² ì´ìŠ¤ ì„œë¹„ìŠ¤ ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘..."
export PGPASSWORD=postgres
MAX_RETRIES=10
COUNT=0
while ! psql -h 172.17.0.1 -U postgres -d challenfit -c "SELECT 1;" >/dev/null 2>&1; do
    if [ "$COUNT" -ge "$MAX_RETRIES" ]; then
        echo "âŒ PostgreSQL ì—°ê²° ì‹¤íŒ¨"
        exit 1
    fi
    echo "ğŸŸ¡ PostgreSQL ì—°ê²° ëŒ€ê¸° ì¤‘... ($COUNT/$MAX_RETRIES)"
    sleep 3
    COUNT=$((COUNT + 1))
done
echo "âœ… PostgreSQL ì—°ê²° ì„±ê³µ"

COUNT=0
while ! redis6-cli -h 172.17.0.1 ping >/dev/null 2>&1; do
    if [ "$COUNT" -ge "$MAX_RETRIES" ]; then
        echo "âŒ Redis 6 ì—°ê²° ì‹¤íŒ¨"
        exit 1
    fi
    echo "ğŸŸ¡ Redis 6 ì—°ê²° ëŒ€ê¸° ì¤‘... ($COUNT/$MAX_RETRIES)"
    sleep 3
    COUNT=$((COUNT + 1))
done
echo "âœ… Redis 6 ì—°ê²° ì„±ê³µ"

### 4. ìƒˆ ì»¨í…Œì´ë„ˆ ë¹Œë“œ ë° ì‹œì‘
echo "ğŸ”¨ $NEW ì»¨í…Œì´ë„ˆ ë¹Œë“œ ë° ì‹œì‘..."
docker-compose -p challenfit-backend build "$NEW" || { echo "âŒ ë„ì»¤ ë¹Œë“œ ì‹¤íŒ¨: $NEW"; exit 1; }
docker-compose -p challenfit-backend up -d "$NEW" || { echo "âŒ ë„ì»¤ ì‹œì‘ ì‹¤íŒ¨: $NEW"; exit 1; }

echo "ğŸ”¨ $NEW ì»¨í…Œì´ë„ˆ ë¹Œë“œ ë° ì‹œì‘..."
docker-compose -p challenfit-backend build "$NEW" || { echo "âŒ ë„ì»¤ ë¹Œë“œ ì‹¤íŒ¨: $NEW"; exit 1; }
docker-compose -p challenfit-backend up -d "$NEW" || { echo "âŒ ë„ì»¤ ì‹œì‘ ì‹¤íŒ¨: $NEW"; exit 1; }

### 4-1. LiveKit ì„œë¹„ìŠ¤ ì²˜ë¦¬
echo "ğŸ“¡ LiveKit ì„œë¹„ìŠ¤ ì²˜ë¦¬ ì¤‘..."

# LiveKit ì„œë¹„ìŠ¤ëª… ê²°ì •
if [ "$NEW" = "backend-blue" ]; then
    NEW_LIVEKIT="livekit-blue"
    OLD_LIVEKIT="livekit-green"
    NEW_LIVEKIT_PORT=7880
else
    NEW_LIVEKIT="livekit-green"
    OLD_LIVEKIT="livekit-blue"
    NEW_LIVEKIT_PORT=7882
fi

echo "ğŸ”„ $OLD_LIVEKIT â†’ $NEW_LIVEKIT ìœ¼ë¡œ ì „í™˜í•©ë‹ˆë‹¤"

# ê¸°ì¡´ LiveKit ì»¨í…Œì´ë„ˆë“¤ ëª¨ë‘ ì •ë¦¬
echo "ğŸ§¹ ê¸°ì¡´ LiveKit ì»¨í…Œì´ë„ˆ ì •ë¦¬..."
docker-compose -p challenfit-backend stop livekit-blue livekit-green 2>/dev/null || true
docker-compose -p challenfit-backend rm -f livekit-blue livekit-green 2>/dev/null || true

# ëª¨ë“  LiveKit ì„œë¹„ìŠ¤ë¥¼ ë‹¤ì‹œ ìƒì„± ë° ì‹œì‘
echo "ğŸ”¨ ëª¨ë“  LiveKit ì„œë¹„ìŠ¤ ì¬ìƒì„±..."
docker-compose -p challenfit-backend up -d livekit-blue livekit-green || {
    echo "âŒ LiveKit ì„œë¹„ìŠ¤ ìƒì„± ì‹¤íŒ¨"
    echo "ğŸ“‹ ë””ë²„ê¹… ì •ë³´:"
    docker-compose -p challenfit-backend config --services
    exit 1
}

# ìƒˆë¡œìš´ LiveKitë§Œ ì‹¤í–‰í•˜ê³  ê¸°ì¡´ ê²ƒì€ ì¤‘ì§€
echo "â¸ï¸  $OLD_LIVEKIT ì¤‘ì§€..."
docker-compose -p challenfit-backend stop "$OLD_LIVEKIT" 2>/dev/null || true

echo "âœ… $NEW_LIVEKIT í™œì„±í™” ì™„ë£Œ!"

# LiveKit Health Check
echo "ğŸ¥ LiveKit Health Check ì§„í–‰ ì¤‘..."
MAX_RETRIES=20
COUNT=0
while true; do
    if curl -f "http://localhost:$NEW_LIVEKIT_PORT" >/dev/null 2>&1 && \
       docker ps | grep -q "challenfit-backend-$NEW_LIVEKIT-1.*Up"; then
        echo "âœ… $NEW_LIVEKIT ì„œë¹„ìŠ¤ê°€ ì •ìƒì ìœ¼ë¡œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!"
        break
    fi

    if [ "$COUNT" -ge "$MAX_RETRIES" ]; then
        echo "âŒ LiveKit Health check ì‹¤íŒ¨: $NEW_LIVEKIT"
        echo "ğŸ“‹ ì»¨í…Œì´ë„ˆ ìƒíƒœ:"
        docker ps | grep livekit || echo "LiveKit ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
        echo "ğŸ“‹ LiveKit ë¡œê·¸:"
        docker logs --tail 50 "challenfit-backend-$NEW_LIVEKIT-1" 2>/dev/null || echo "ë¡œê·¸ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
        exit 1
    fi

    echo "ğŸŸ¡ LiveKit Health check ëŒ€ê¸° ì¤‘... ($COUNT/$MAX_RETRIES)"
    echo "   - HTTP ì²´í¬: curl http://localhost:$NEW_LIVEKIT_PORT"
    echo "   - ì»¨í…Œì´ë„ˆ ìƒíƒœ: $(docker ps --filter name=challenfit-backend-$NEW_LIVEKIT-1 --format '{{.Status}}' 2>/dev/null || echo 'ì—†ìŒ')"
    sleep 5
    COUNT=$((COUNT + 1))
done

### 5. Health Check ëŒ€ê¸°
echo "ğŸ¥ Health Check ì§„í–‰ ì¤‘..."
MAX_RETRIES=30
COUNT=0
while true; do
    HEALTH_STATUS=$(docker inspect --format='{{.State.Health.Status}}' challenfit-backend-$NEW-1 2>/dev/null || echo 'starting')

    if [ "$HEALTH_STATUS" = "healthy" ]; then
        echo "âœ… $NEW ì»¨í…Œì´ë„ˆê°€ ì •ìƒì ìœ¼ë¡œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!"
        break
    fi

    if [ "$COUNT" -ge "$MAX_RETRIES" ]; then
        echo "âŒ Health check ì‹¤íŒ¨: $NEW ì»¨í…Œì´ë„ˆê°€ ì •ìƒ ìƒíƒœê°€ ì•„ë‹™ë‹ˆë‹¤."
        echo "ğŸ“‹ ì»¨í…Œì´ë„ˆ ìƒíƒœ: $HEALTH_STATUS"
        echo "ğŸ“‹ ì»¨í…Œì´ë„ˆ ë¡œê·¸:"
        docker logs --tail 100 challenfit-backend-$NEW-1
        exit 1
    fi

    echo "ğŸŸ¡ Health check ëŒ€ê¸° ì¤‘... ($COUNT/$MAX_RETRIES) - ìƒíƒœ: $HEALTH_STATUS"
    if [ $((COUNT % 10)) -eq 0 ] && [ "$COUNT" -gt 0 ]; then
        echo "ğŸ“‹ í˜„ì¬ ì»¨í…Œì´ë„ˆ ë¡œê·¸ (ìµœê·¼ 10ì¤„):"
        docker logs --tail 10 challenfit-backend-$NEW-1
    fi

    sleep 10
    COUNT=$((COUNT + 1))
done

### 6. Nginx ì„¤ì • ì—…ë°ì´íŠ¸
echo "ğŸ”€ Nginx upstream ì„¤ì • ì—…ë°ì´íŠ¸ ì¤‘..."
NGINX_CONFIG="/etc/nginx/conf.d/challenfit.conf"

if [ ! -f "$NGINX_CONFIG" ]; then
    echo "ğŸ“ Nginx ì„¤ì • íŒŒì¼ ìƒì„± ì¤‘..."
    sudo tee "$NGINX_CONFIG" > /dev/null <<EOF
upstream challenfit_backend {
    server localhost:3002 max_fails=3 fail_timeout=30s;
    server localhost:3000 backup max_fails=3 fail_timeout=30s;
}

server {
    listen 80;
    server_name 43.200.3.200 localhost;

    client_max_body_size 100M;

    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;

    location /health {
        proxy_pass http://challenfit_backend/health;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;

        proxy_connect_timeout 5s;
        proxy_send_timeout 5s;
        proxy_read_timeout 5s;
    }
    location / {
        proxy_pass http://challenfit_backend;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;

        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection "upgrade";

        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS";
        add_header Access-Control-Allow-Headers "Content-Type, Authorization, Cookie, Origin, x-member-seq";

        if (\$request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Origin *;
            add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS";
            add_header Access-Control-Allow-Headers "Content-Type, Authorization, Cookie, Origin, x-member-seq";
            add_header Content-Length 0;
            add_header Content-Type text/plain;
            return 204;
        }
    }

    location /Uploads/ {
        proxy_pass http://challenfit_backend;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;

        expires 1h;
        add_header Cache-Control "public, immutable";
    }

    location /nginx_status {
        stub_status on;
        access_log off;
        allow 127.0.0.1;
        allow 10.0.0.0/8;
        deny all;
    }

    access_log /var/log/nginx/challenfit_access.log;
    error_log /var/log/nginx/challenfit_error.log;
}
EOF
fi

if [ "$NEW" == "backend-green" ]; then
    sudo sed -i 's/server localhost:3000 max_fails=3 fail_timeout=30s;/server localhost:3000 backup max_fails=3 fail_timeout=30s;/g' "$NGINX_CONFIG"
    sudo sed -i 's/server localhost:3002 backup max_fails=3 fail_timeout=30s;/server localhost:3002 max_fails=3 fail_timeout=30s;/g' "$NGINX_CONFIG"
    echo "ğŸŸ¢ Green ì„œë²„(í¬íŠ¸ 3002)ë¡œ íŠ¸ë˜í”½ ì „í™˜"
else
    sudo sed -i 's/server localhost:3002 max_fails=3 fail_timeout=30s;/server localhost:3002 backup max_fails=3 fail_timeout=30s;/g' "$NGINX_CONFIG"
    sudo sed -i 's/server localhost:3000 backup max_fails=3 fail_timeout=30s;/server localhost:3000 max_fails=3 fail_timeout=30s;/g' "$NGINX_CONFIG"
    echo "ğŸ”µ Blue ì„œë²„(í¬íŠ¸ 3000)ë¡œ íŠ¸ë˜í”½ ì „í™˜"
fi

### 7. Nginx ì„¤ì • í…ŒìŠ¤íŠ¸ ë° ë¦¬ë¡œë“œ
echo "ğŸ”§ Nginx ì„¤ì • í…ŒìŠ¤íŠ¸ ì¤‘..."
sudo nginx -t || { echo "âŒ Nginx ì„¤ì • ì˜¤ë¥˜"; exit 1; }

echo "âœ… Nginx ì„¤ì •ì´ ìœ íš¨í•©ë‹ˆë‹¤. ë¦¬ë¡œë“œ ì§„í–‰..."
sudo nginx -s reload || { echo "âŒ Nginx ë¦¬ë¡œë“œ ì‹¤íŒ¨"; exit 1; }
echo "ğŸ”„ Nginxê°€ ì„±ê³µì ìœ¼ë¡œ ë¦¬ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤."

### 8. ìƒˆ ì„œë²„ ì ‘ì† í…ŒìŠ¤íŠ¸
echo "ğŸ§ª ìƒˆ ì„œë²„ ì ‘ì† í…ŒìŠ¤íŠ¸ ì¤‘..."
sleep 10
MAX_RETRIES=10
COUNT=0
while ! curl -f http://localhost:$NEW_PORT/health >/dev/null 2>&1; do
    if [ "$COUNT" -ge "$MAX_RETRIES" ]; then
        echo "âŒ ìƒˆ ì„œë²„ ì ‘ì† í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"
        echo "ğŸ“‹ ë””ë²„ê¹… ì •ë³´:"
        curl -v http://localhost:$NEW_PORT/health
        docker-compose -p challenfit-backend ps
        docker logs --tail 100 challenfit-backend-$NEW-1
        exit 1
    fi
    echo "ğŸŸ¡ ì ‘ì† í…ŒìŠ¤íŠ¸ ì¬ì‹œë„ ì¤‘... ($COUNT/$MAX_RETRIES)"
    sleep 5
    COUNT=$((COUNT + 1))
done

echo "âœ… ìƒˆ ì„œë²„ ì ‘ì† í…ŒìŠ¤íŠ¸ ì„±ê³µ!"

### 9. ê¸°ì¡´ OLD ì»¨í…Œì´ë„ˆ ì¤‘ì§€
if [ "$OLD" != "$NEW" ]; then
    echo "ğŸ›‘ ê¸°ì¡´ $OLD ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ì¤‘..."
    sleep 30
    docker-compose -p challenfit-backend stop "$OLD" || true
    echo "ğŸ”’ $OLD ì»¨í…Œì´ë„ˆëŠ” ì¢…ë£Œë˜ì—ˆìœ¼ë‚˜ ì‚­ì œí•˜ì§€ ì•Šê³  ë³´ê´€í•©ë‹ˆë‹¤."
fi

### 9-1. ê¸°ì¡´ OLD LiveKit ì»¨í…Œì´ë„ˆ ì¤‘ì§€
if [ "$OLD_LIVEKIT" != "$NEW_LIVEKIT" ]; then
    echo "ğŸ›‘ ê¸°ì¡´ $OLD_LIVEKIT ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ì¤‘..."
    sleep 30  # ê¸°ì¡´ ì—°ê²°ì´ ì™„ì „íˆ ì¢…ë£Œë  ë•Œê¹Œì§€ ëŒ€ê¸°
    docker-compose -p challenfit-backend stop "$OLD_LIVEKIT" || true
    echo "ğŸ”’ $OLD_LIVEKIT ì»¨í…Œì´ë„ˆëŠ” ì¢…ë£Œë˜ì—ˆìœ¼ë‚˜ ì‚­ì œí•˜ì§€ ì•Šê³  ë³´ê´€í•©ë‹ˆë‹¤."
fi

### 10. ë°°í¬ ì™„ë£Œ ë©”ì‹œì§€
echo "ğŸ‰ ë°°í¬ ì™„ë£Œ! ì„œë¹„ìŠ¤ê°€ http://43.200.3.200 ì—ì„œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤."
echo "ğŸ“Š í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ:"
docker-compose -p challenfit-backend ps
echo ""
echo "ğŸ“ ìœ ìš©í•œ ëª…ë ¹ì–´:"
echo "  - ë¡œê·¸ í™•ì¸: docker-compose -p challenfit-backend logs -f $NEW"
echo "  - ìƒíƒœ í™•ì¸: docker-compose -p challenfit-backend ps"
echo "  - ë¡¤ë°±: docker-compose -p challenfit-backend up -d $OLD && docker-compose -p challenfit-backend stop $NEW"
