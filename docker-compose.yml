name: challenfit-backend

services:
  # Blue 백엔드 서버
  backend-blue:
    build: .
    env_file:
      - .env
    environment:
      - NODE_ENV=production
      - DB_HOST=172.17.0.1
      - REDIS_HOST=172.17.0.1
      - BACKEND_SERVICE=backend-blue
      - LIVEKIT_ENVIRONMENT=blue
    ports:
      - '3000:3000'
    restart: always
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3000/health']
      interval: 30s
      start_period: 180s
      timeout: 10s
      retries: 3
    networks:
      - backend-net
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    volumes:
      - ./.env:/app/.env:ro

  # Green 백엔드 서버
  backend-green:
    build: .
    env_file:
      - .env
    environment:
      - NODE_ENV=production
      - DB_HOST=172.17.0.1
      - REDIS_HOST=172.17.0.1
      - BACKEND_SERVICE=backend-green
      - LIVEKIT_ENVIRONMENT=green
    ports:
      - '3002:3000'
    restart: always
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3000/health']
      interval: 30s
      start_period: 180s
      timeout: 10s
      retries: 3
    networks:
      - backend-net
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    volumes:
      - ./.env:/app/.env:ro

  # LiveKit SFU - Blue와 Green 각각 별도 인스턴스
  # container_name 제거하여 docker-compose 프로젝트 이름 기반으로 자동 생성
  livekit-blue:
    image: livekit/livekit-server:latest
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - LIVEKIT_PORT=7880
      - LIVEKIT_TCP_PORT=7881
      - BACKEND_SERVICE=backend-blue:3000
    volumes:
      - ./livekit-blue.yaml:/etc/livekit.yaml:ro
    command: ['--config', '/etc/livekit.yaml']
    ports:
      - '7880:7880'
      - '7881:7881/tcp'
      - '50000-50099:50000-50099/udp'
    networks:
      - backend-net
    healthcheck:
      test: ['CMD', 'wget', '--spider', '-q', 'http://localhost:7880']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  livekit-green:
    image: livekit/livekit-server:latest
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - LIVEKIT_PORT=7882
      - LIVEKIT_TCP_PORT=7883
      - BACKEND_SERVICE=backend-green:3000
    volumes:
      - ./livekit-green.yaml:/etc/livekit.yaml:ro
    command: ['--config', '/etc/livekit.yaml']
    ports:
      - '7882:7882'
      - '7883:7883/tcp'
      - '50100-50199:50100-50199/udp'
    networks:
      - backend-net
    healthcheck:
      test: ['CMD', 'wget', '--spider', '-q', 'http://localhost:7882']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # TURN 서버 (coturn)
  coturn:
    image: instrumentisto/coturn
    container_name: coturn
    restart: unless-stopped
    command:
      - -n
      - --no-cli
      - --lt-cred-mech
      - --realm=${TURN_REALM}
      - --user=${TURN_USERNAME}:${TURN_PASSWORD}
      - --external-ip=${PUBLIC_IP}
      - --min-port=${TURN_MIN_PORT}
      - --max-port=${TURN_MAX_PORT}
      - --fingerprint
    ports:
      - '3478:3478/udp'
      - '3478:3478/tcp'
      - '${TURN_MIN_PORT}-${TURN_MAX_PORT}:${TURN_MIN_PORT}-${TURN_MAX_PORT}/udp'
    networks:
      - backend-net

networks:
  backend-net:
    driver: bridge