name: challenfit-backend

services:
  # Blue 백엔드 서버
  backend-blue:
    build: .
    env_file:
      - .env
    environment:
      - NODE_ENV=production
      - DB_HOST=172.17.0.1
      - REDIS_HOST=172.17.0.1
    ports:
      - '3000:3000'
    restart: always
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3000/health']
      interval: 30s
      start_period: 180s
      timeout: 10s
      retries: 3
    networks:
      - backend-net
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    volumes:
      - ./.env:/app/.env:ro

  # Green 백엔드 서버
  backend-green:
    build: .
    env_file:
      - .env
    environment:
      - NODE_ENV=production
      - DB_HOST=172.17.0.1
      - REDIS_HOST=172.17.0.1
    ports:
      - '3002:3000'
    restart: always
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3000/health']
      interval: 30s
      start_period: 180s
      timeout: 10s
      retries: 3
    networks:
      - backend-net
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    volumes:
      - ./.env:/app/.env:ro

  # LiveKit SFU
  livekit:
    image: livekit/livekit-server:latest
    container_name: livekit
    restart: unless-stopped
    env_file:
      - .env
    volumes:
      - ./livekit.yaml:/etc/livekit.yaml:ro
    command: ['--config', '/etc/livekit.yaml']
    ports:
      - '7880:7880' # 시그널링(HTTP/WS)
      - '7881:7881/tcp' # TCP 미디어(옵션)
      - '50000-50100:50000-50100/udp' # 미디어 UDP
    networks:
      - backend-net

  # TURN 서버 (coturn)
  coturn:
    image: instrumentisto/coturn
    container_name: coturn
    restart: unless-stopped
    command:
      - -n
      - --no-cli
      - --lt-cred-mech
      - --realm=${TURN_REALM}
      - --user=${TURN_USERNAME}:${TURN_PASSWORD}
      - --external-ip=${PUBLIC_IP}
      - --min-port=${TURN_MIN_PORT}
      - --max-port=${TURN_MAX_PORT}
      - --fingerprint
    ports:
      - '3478:3478/udp'
      - '3478:3478/tcp'
      - '${TURN_MIN_PORT}-${TURN_MAX_PORT}:${TURN_MIN_PORT}-${TURN_MAX_PORT}/udp'
    networks:
      - backend-net

networks:
  backend-net:
    driver: bridge
